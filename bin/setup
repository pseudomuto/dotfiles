#!/bin/bash
set -uo pipefail
source "${0%/*}/../lib/util.sh"
source "${0%/*}/../lib/tasks.sh"

trap "cleanup_pipes" EXIT

task() {
  _echo "${1}"
  run_task "$@"
  wait $current_task_pid
}

run_phase() {
  _echo "$(colorize "${1}" $purple_color)" "┏━━ "
  eval "${2}" || end_phase "Phase '${1}' failed. Aborting now."
  end_phase
}

end_phase() {
  _echo "" "┗━━ "
  if [ -n "${1:-}" ]; then fail "${1}"; fi
}

main() {
  run_phase "Setup prerequisites and symlinks" "install_prerequisites"
  run_phase "Install development environment" "install_development_environments"
  run_phase "Install applications" "install_packages"
  run_phase "Fetch dependencies" "install_source_dependencies"

  echo -e "$(colorize "✓ All done" $green_color)"
}

main "$@"
