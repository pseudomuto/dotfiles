#!/bin/bash
set -uo pipefail
source "${0%/*}/../share/dotfiles/util.sh"

trap "cleanup_pipes" EXIT

symlink_files() {
  task "symlink files" "bin/install files -s share/dotfiles/files" || return $?
}

install_packages() {
  task "install base packages" "bin/install packages autoconf build-essential curl wget" || return $?
  task "install git" "bin/install git -v 2.9.2" || return $?
  task "install ruby-install" "bin/install ruby-install -v 0.6.0" || return $?
  task "install system ruby 2.3.1" "bin/install ruby -v 2.3.1 -s" || return $?
  task "install user ruby 2.2.4" "bin/install ruby -v 2.2.4" || return $?
  task "install chruby" "bin/install chruby -v 0.3.9" || return $?
}

task() {
  _echo "${1}"
  run_task "$@"
  wait $current_task_pid
}

run_phase() {
  _echo "$(colorize "${1}" $purple_color)" "┏━━ "
  eval "${2}" || end_phase "Phase '${1}' failed. Aborting now."
  end_phase
}

end_phase() {
  _echo "" "┗━━ "
  if [ -n "${1:-}" ]; then fail "${1}"; fi
}

main() {
  run_phase "Symlink dotfiles" "symlink_files"
  run_phase "Install packages" "install_packages"

  echo -e "$(colorize "✓ All done" $green_color)"
}

main "$@"
