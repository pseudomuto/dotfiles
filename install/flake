#!/usr/bin/env bash
set -euo pipefail

# Source Nix profile from various locations
source_nix_profile() {
  if [ -f "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" ]; then
    . "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
  elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
    . "$HOME/.nix-profile/etc/profile.d/nix.sh"
  elif [ -f "/etc/profile.d/nix.sh" ]; then
    . "/etc/profile.d/nix.sh"
  fi

  # For containers, ensure PATH is set
  if is_container; then
    export PATH="$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:$PATH"
  fi
}

main() {
  # Ensure Nix is available
  source_nix_profile
  
  # Verify nix command is available
  if ! command -v nix &>/dev/null; then
    log_error "Nix command not found. Ensure Nix is installed and profile is sourced."
    exit 1
  fi

  # Ensure Nix daemon is running in containers
  if is_container; then
    if ! pgrep -f "nix-daemon" >/dev/null 2>&1; then
      log_info "Starting Nix daemon..."
      if sudo systemctl start nix-daemon 2>/dev/null; then
        sleep 2  # Give daemon time to start
      elif sudo /nix/var/nix/profiles/default/bin/nix-daemon --daemon & then
        sleep 2  # Give daemon time to start
      else
        log_warn "Could not start Nix daemon - operations may fail"
      fi
    fi
  fi

  # Check if we should update flake inputs
  local force_refresh="${FORCE_REFRESH:-false}"

  if [[ "$force_refresh" == "true" ]] || should_update_flake; then
    log_info "Updating flake inputs..."

    # Ensure we're in the dotfiles directory
    cd "${DOTFILES_DIR}"

    if ! nix flake update; then
      log_warn "Failed to update flake inputs, continuing with existing ones"
    else
      log_info "Flake inputs updated successfully"
    fi
  else
    log_info "Flake inputs are up to date (use --refresh to force update)"
  fi
}

# Check if running in a container
is_container() {
  # Check for Docker
  if [ -f /.dockerenv ]; then
    return 0
  fi

  # Check for systemd (containers typically don't have it)
  if [ "$(uname -s)" = "Linux" ] && ! pidof systemd >/dev/null 2>&1 && [ ! -d /run/systemd/system ]; then
    return 0
  fi

  return 1
}

# Check if flake needs updating (older than 7 days)
should_update_flake() {
  if [ ! -f "flake.lock" ]; then
    return 0 # No lock file, should update
  fi

  # Check if lock file is older than 7 days
  if [ "$(uname)" = "Darwin" ]; then
    # macOS
    local lock_age=$(($(date +%s) - $(stat -f %m flake.lock)))
  else
    # Linux
    local lock_age=$(($(date +%s) - $(stat -c %Y flake.lock)))
  fi

  # 7 days in seconds = 604800
  if [ $lock_age -gt 604800 ]; then
    return 0
  else
    return 1
  fi
}

main "$@"

